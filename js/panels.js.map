{"version":3,"file":"panels.js","names":["PSRouter","roomid","panelState","currentRoomid","location","pathname","slice","test","subscribeHistory","endsWith","subscribeHash","_proto","prototype","extractRoomID","url","startsWith","document","origin","length","host","PS","server","id","replace","redirects","hash","join","subscribeAndRun","room","window","addEventListener","e","possibleRoomid","_this","history","leftRoomWidth","leftRoom","rightRoom","pushState","title","replaceState","state","_ref","split","leftRoomid","rightRoomid","router","PSRoomPanel","_preact$Component","_inheritsLoose","_this2","_len","arguments","args","Array","_key","call","apply","concat","subscriptions","_proto2","componentDidMount","_this3","props","focus","onParentEvent","push","subscribe","forceUpdate","receiveLine","base","setDimensions","offsetWidth","offsetHeight","componentDidUpdate","includes","componentWillUnmount","_i2","_this$subscriptions2","subscription","unsubscribe","chooseParentValue","value","dropdownButton","parentElem","changeEvent","Event","dispatchEvent","closePopup","render","preact","h","PSPanelWrapper","Component","children","style","PSMain","getPopupStyle","width","posStyle","scrollable","_preact$Component2","_this4","_elem","elem","target","className","preventDefault","stopImmediatePropagation","clickedRoom","name","getAttribute","userid","toID","addRoom","parentRoomid","containingRoomid","rightPopup","username","update","tagName","href","getRoom","leave","handleButtonClick","rooms","parentElement","popups","isTextInput","type","modifierKey","ctrlKey","altKey","metaKey","shiftKey","keyCode","arrowKeysUsed","focusLeftRoom","focusRightRoom","colorSchemeQuery","matchMedia","media","cs","prefs","theme","body","matches","key","dark","_proto3","curElem","mainmenu","send","isEmptyClick","selection","getSelection","err","BattleTooltips","hideTooltip","pos","activePanel","top","right","left","display","height","bottom","RangeError","position","visibility","margin","offset","getBoundingClientRect","sourceWidth","sourceHeight","availableHeight","documentElement","clientHeight","Math","max","offsetLeft","clientWidth","availableWidth","maxWidth","renderRoom","roomType","roomTypes","Panel","renderPopup","_this5","PSHeader","map","SanitizedHTML","dangerouslySetInnerHTML","__html","BattleLog","sanitizeHTML"],"sources":["../src/panels.tsx"],"sourcesContent":["/**\r\n * Panels\r\n *\r\n * Main view - sets up the frame, and the generic panels.\r\n *\r\n * Also sets up most global event listeners.\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license AGPLv3\r\n */\r\n\r\nclass PSRouter {\r\n\troomid = '' as RoomID;\r\n\tpanelState = '';\r\n\tconstructor() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tthis.subscribeHistory();\r\n\t\t} else if (location.pathname.endsWith('.html')) {\r\n\t\t\tthis.subscribeHash();\r\n\t\t}\r\n\t}\r\n\textractRoomID(url: string) {\r\n\t\tif (url.startsWith(document.location.origin)) {\r\n\t\t\turl = url.slice(document.location.origin.length);\r\n\t\t} else {\r\n\t\t\tif (url.startsWith('http://')) {\r\n\t\t\t\turl = url.slice(7);\r\n\t\t\t} else if (url.startsWith('https://')) {\r\n\t\t\t\turl = url.slice(8);\r\n\t\t\t}\r\n\t\t\tif (url.startsWith(document.location.host)) {\r\n\t\t\t\turl = url.slice(document.location.host.length);\r\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('play.pokemonshowdown.com')) {\r\n\t\t\t\turl = url.slice(24);\r\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('psim.us')) {\r\n\t\t\t\turl = url.slice(7);\r\n\t\t\t} else if (url.startsWith('replay.pokemonshowdown.com')) {\r\n\t\t\t\turl = url.slice(26).replace('/', '/battle-');\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (url.startsWith('/')) url = url.slice(1);\r\n\r\n\t\tif (!/^[a-z0-9-]*$/.test(url)) return null;\r\n\r\n\t\tconst redirects = /^(appeals?|rooms?suggestions?|suggestions?|adminrequests?|bugs?|bugreports?|rules?|faq|credits?|privacy|contact|dex|insecure)$/;\r\n\t\tif (redirects.test(url)) return null;\r\n\r\n\t\treturn url as RoomID;\r\n\t}\r\n\tsubscribeHash() {\r\n\t\tif (location.hash) {\r\n\t\t\tconst currentRoomid = location.hash.slice(1);\r\n\t\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t\t} else {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst roomid = PS.room.id;\r\n\t\t\tlocation.hash = roomid ? '#' + roomid : '';\r\n\t\t});\r\n\t\twindow.addEventListener('hashchange', e => {\r\n\t\t\tconst possibleRoomid = location.hash.slice(1);\r\n\t\t\tlet currentRoomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\tcurrentRoomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (currentRoomid !== null) {\r\n\t\t\t\tPS.join(currentRoomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tsubscribeHistory() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t} else {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!window.history) return;\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst room = PS.room;\r\n\t\t\tconst roomid = room.id;\r\n\t\t\tconst panelState = (PS.leftRoomWidth ?\r\n\t\t\t\tPS.leftRoom.id + '..' + PS.rightRoom!.id :\r\n\t\t\t\troomid);\r\n\t\t\tif (roomid === this.roomid && panelState === this.panelState) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (panelState === this.panelState) {\r\n\t\t\t\thistory.pushState(panelState, room.title, '/' + roomid);\r\n\t\t\t} else {\r\n\t\t\t\thistory.replaceState(panelState, room.title, '/' + roomid);\r\n\t\t\t}\r\n\t\t\tthis.roomid = roomid;\r\n\t\t\tthis.panelState = panelState;\r\n\t\t});\r\n\t\twindow.addEventListener('popstate', e => {\r\n\t\t\tconst possibleRoomid = location.pathname.slice(1);\r\n\t\t\tlet roomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\troomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (typeof e.state === 'string') {\r\n\t\t\t\tconst [leftRoomid, rightRoomid] = e.state.split('..') as RoomID[];\r\n\t\t\t\tPS.join(leftRoomid, 'left');\r\n\t\t\t\tif (rightRoomid) {\r\n\t\t\t\t\tPS.join(rightRoomid, 'right');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (roomid !== null) {\r\n\t\t\t\tPS.join(roomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\nPS.router = new PSRouter();\r\n\r\nclass PSRoomPanel<T extends PSRoom = PSRoom> extends preact.Component<{room: T}> {\r\n\tsubscriptions: PSSubscription[] = [];\r\n\tcomponentDidMount() {\r\n\t\tif (PS.room === this.props.room) this.focus();\r\n\t\tthis.props.room.onParentEvent = (id: string, e?: Event) => {\r\n\t\t\tif (id === 'focus') this.focus();\r\n\t\t};\r\n\t\tthis.subscriptions.push(this.props.room.subscribe(args => {\r\n\t\t\tif (!args) this.forceUpdate();\r\n\t\t\telse this.receiveLine(args);\r\n\t\t}));\r\n\t\tif (this.base) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentDidUpdate() {\r\n\t\tif (this.base && ['popup', 'semimodal-popup'].includes(this.props.room.location)) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentWillUnmount() {\r\n\t\tthis.props.room.onParentEvent = null;\r\n\t\tfor (const subscription of this.subscriptions) {\r\n\t\t\tsubscription.unsubscribe();\r\n\t\t}\r\n\t\tthis.subscriptions = [];\r\n\t}\r\n\treceiveLine(args: Args) {}\r\n\t/**\r\n\t * PS has \"fake select menus\", buttons that act like <select> dropdowns.\r\n\t * This function is used by the popups they open to change the button\r\n\t * values.\r\n\t */\r\n\tchooseParentValue(value: string) {\r\n\t\tconst dropdownButton = this.props.room.parentElem as HTMLButtonElement;\r\n\t\tdropdownButton.value = value;\r\n\t\tconst changeEvent = new Event('change');\r\n\t\tdropdownButton.dispatchEvent(changeEvent);\r\n\t\tPS.closePopup();\r\n\t}\r\n\tfocus() {}\r\n\trender() {\r\n\t\treturn <PSPanelWrapper room={this.props.room}>\r\n\t\t\t<div class=\"mainmessage\"><p>Loading...</p></div>\r\n\t\t</PSPanelWrapper>;\r\n\t}\r\n}\r\n\r\nfunction PSPanelWrapper(props: {\r\n\troom: PSRoom, children: preact.ComponentChildren, scrollable?: boolean, width?: number | 'auto',\r\n}) {\r\n\tconst room = props.room;\r\n\tif (room.location === 'mini-window') {\r\n\t\tif (room.id === 'news') {\r\n\t\t\treturn <div>{props.children}</div>;\r\n\t\t}\r\n\t\treturn <div id={`room-${room.id}`} class=\"mini-window-contents ps-room-light\">{props.children}</div>;\r\n\t}\r\n\tif (room.location !== 'left' && room.location !== 'right') {\r\n\t\tconst style = PSMain.getPopupStyle(room, props.width);\r\n\t\treturn <div class=\"ps-popup\" id={`room-${room.id}`} style={style}>\r\n\t\t\t{props.children}\r\n\t\t</div>;\r\n\t}\r\n\tconst style = PSMain.posStyle(room);\r\n\treturn <div\r\n\t\tclass={'ps-room' + (room.id === '' ? '' : ' ps-room-light') + (props.scrollable ? ' scrollable' : '')}\r\n\t\tid={`room-${room.id}`}\r\n\t\tstyle={style}\r\n\t>\r\n\t\t{props.children}\r\n\t</div>;\r\n}\r\n\r\nclass PSMain extends preact.Component {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\tPS.subscribe(() => this.forceUpdate());\r\n\r\n\t\twindow.addEventListener('click', e => {\r\n\t\t\tlet elem = e.target as HTMLElement | null;\r\n\t\t\tif (elem?.className === 'ps-overlay') {\r\n\t\t\t\tPS.closePopup();\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet clickedRoom = null;\r\n\t\t\twhile (elem) {\r\n\t\t\t\tif (` ${elem.className} `.includes(' username ')) {\r\n\t\t\t\t\tconst name = elem.getAttribute('data-name');\r\n\t\t\t\t\tconst userid = toID(name);\r\n\t\t\t\t\tconst roomid = `user-${userid}` as RoomID;\r\n\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\tparentRoomid: PSMain.containingRoomid(elem),\r\n\t\t\t\t\t\trightPopup: elem.className === 'userbutton username',\r\n\t\t\t\t\t\tusername: name,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tPS.update();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'A' || elem.getAttribute('data-href')) {\r\n\t\t\t\t\tconst href = elem.getAttribute('data-href') || (elem as HTMLAnchorElement).href;\r\n\t\t\t\t\tconst roomid = PS.router.extractRoomID(href);\r\n\r\n\t\t\t\t\tif (roomid !== null) {\r\n\t\t\t\t\t\tif (elem.getAttribute('data-target') === 'replace') {\r\n\t\t\t\t\t\t\tconst room = this.getRoom(elem);\r\n\t\t\t\t\t\t\tif (room) PS.leave(room.id);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tPS.update();\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'BUTTON') {\r\n\t\t\t\t\tif (this.handleButtonClick(elem as HTMLButtonElement)) {\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t} else if (!elem.getAttribute('type')) {\r\n\t\t\t\t\t\t// the spec says that buttons with no `type` attribute should be\r\n\t\t\t\t\t\t// submit buttons, but this is a bad default so we're going\r\n\t\t\t\t\t\t// to just assume they're not\r\n\r\n\t\t\t\t\t\t// don't return, to allow <a><button> to make links that look\r\n\t\t\t\t\t\t// like buttons\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// presumably a different part of the app is handling this button\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.id.startsWith('room-')) {\r\n\t\t\t\t\tclickedRoom = PS.rooms[elem.id.slice(5)];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telem = elem.parentElement;\r\n\t\t\t}\r\n\t\t\tif (PS.room !== clickedRoom) {\r\n\t\t\t\tif (clickedRoom) PS.room = clickedRoom;\r\n\t\t\t\twhile (PS.popups.length && (!clickedRoom || clickedRoom.id !== PS.popups[PS.popups.length - 1])) {\r\n\t\t\t\t\tPS.closePopup();\r\n\t\t\t\t}\r\n\t\t\t\tPS.update();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\twindow.addEventListener('keydown', e => {\r\n\t\t\tlet elem = e.target as HTMLInputElement | null;\r\n\t\t\tif (elem) {\r\n\t\t\t\tlet isTextInput = (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA');\r\n\t\t\t\tif (isTextInput && ['button', 'radio', 'checkbox', 'file'].includes(elem.type)) {\r\n\t\t\t\t\tisTextInput = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (isTextInput && elem.value) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (PS.room.onParentEvent) {\r\n\t\t\t\tif (PS.room.onParentEvent('keydown', e) === false) {\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlet modifierKey = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;\r\n\t\t\tif (modifierKey) return;\r\n\t\t\tif (e.keyCode === 37) { // left\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusLeftRoom();\r\n\t\t\t} else if (e.keyCode === 39) { // right\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusRightRoom();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tconst colorSchemeQuery = window.matchMedia?.('(prefers-color-scheme: dark)');\r\n\t\tif (colorSchemeQuery?.media !== 'not all') {\r\n\t\t\tcolorSchemeQuery.addEventListener('change', function (cs) {\r\n\t\t\t\tif (PS.prefs.theme === 'system') document.body.className = cs.matches ? 'dark' : '';\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tPS.prefs.subscribeAndRun(key => {\r\n\t\t\tif (!key || key === 'theme') {\r\n\t\t\t\tconst dark = PS.prefs.theme === 'dark' ||\r\n\t\t\t\t\t(PS.prefs.theme === 'system' && colorSchemeQuery && colorSchemeQuery.matches);\r\n\t\t\t\tdocument.body.className = dark ? 'dark' : '';\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tgetRoom(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn PS.rooms[curElem.id.slice(5)];\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t}\r\n\thandleButtonClick(elem: HTMLButtonElement) {\r\n\t\tswitch (elem.name) {\r\n\t\tcase 'closeRoom':\r\n\t\t\tPS.leave(elem.value as RoomID);\r\n\t\t\treturn true;\r\n\t\tcase 'joinRoom':\r\n\t\t\tPS.addRoom({\r\n\t\t\t\tid: elem.value as RoomID,\r\n\t\t\t\tparentElem: elem,\r\n\t\t\t});\r\n\t\t\tPS.update();\r\n\t\t\treturn true;\r\n\t\tcase 'send':\r\n\t\tcase 'cmd':\r\n\t\t\tconst room = this.getRoom(elem) || PS.mainmenu;\r\n\t\t\troom.send(elem.value, elem.name === 'send');\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\tstatic containingRoomid(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn curElem.id.slice(5) as RoomID;\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\tstatic isEmptyClick(e: MouseEvent) {\r\n\t\ttry {\r\n\t\t\tconst selection = window.getSelection()!;\r\n\t\t\tif (selection.type === 'Range') return false;\r\n\t\t} catch (err) {}\r\n\t\tBattleTooltips.hideTooltip();\r\n\t}\r\n\tstatic posStyle(room: PSRoom) {\r\n\t\tlet pos: PanelPosition | null = null;\r\n\t\tif (PS.leftRoomWidth === 0) {\r\n\t\t\t// one panel visible\r\n\t\t\tif (room === PS.activePanel) pos = {top: 56};\r\n\t\t} else {\r\n\t\t\t// both panels visible\r\n\t\t\tif (room === PS.leftRoom) pos = {top: 56, right: PS.leftRoomWidth};\r\n\t\t\tif (room === PS.rightRoom) pos = {top: 56, left: PS.leftRoomWidth};\r\n\t\t}\r\n\r\n\t\tif (!pos) return {display: 'none'};\r\n\r\n\t\tlet top: number | null = (pos.top || 0);\r\n\t\tlet height: number | null = null;\r\n\t\tlet bottom: number | null = (pos.bottom || 0);\r\n\t\tif (bottom > 0 || top < 0) {\r\n\t\t\theight = bottom - top;\r\n\t\t\tif (height < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (top < 0) top = null;\r\n\t\t\telse bottom = null;\r\n\t\t}\r\n\r\n\t\tlet left: number | null = (pos.left || 0);\r\n\t\tlet width: number | null = null;\r\n\t\tlet right: number | null = (pos.right || 0);\r\n\t\tif (right > 0 || left < 0) {\r\n\t\t\twidth = right - left - 1;\r\n\t\t\tif (width < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (left < 0) left = null;\r\n\t\t\telse right = null;\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tdisplay: 'block',\r\n\t\t\ttop: top === null ? `auto` : `${top}px`,\r\n\t\t\theight: height === null ? `auto` : `${height}px`,\r\n\t\t\tbottom: bottom === null ? `auto` : `${-bottom}px`,\r\n\t\t\tleft: left === null ? `auto` : `${left}px`,\r\n\t\t\twidth: width === null ? `auto` : `${width}px`,\r\n\t\t\tright: right === null ? `auto` : `${-right}px`,\r\n\t\t};\r\n\t}\r\n\tstatic getPopupStyle(room: PSRoom, width?: number | 'auto'): any {\r\n\t\tif (room.location === 'modal-popup' || !room.parentElem) {\r\n\t\t\treturn {width: width || 480};\r\n\t\t}\r\n\t\tif (!room.width || !room.height) {\r\n\t\t\treturn {\r\n\t\t\t\tposition: 'absolute',\r\n\t\t\t\tvisibility: 'hidden',\r\n\t\t\t\tmargin: 0,\r\n\t\t\t\ttop: 0,\r\n\t\t\t\tleft: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\t// nonmodal popup: should be positioned near source element\r\n\t\tlet style: any = {\r\n\t\t\tposition: 'absolute',\r\n\t\t\tmargin: 0,\r\n\t\t};\r\n\t\tlet offset = room.parentElem.getBoundingClientRect();\r\n\t\tlet sourceWidth = offset.width;\r\n\t\tlet sourceHeight = offset.height;\r\n\r\n\t\tlet availableHeight = document.documentElement.clientHeight;\r\n\t\tlet height = room.height;\r\n\t\twidth = width || room.width;\r\n\r\n\t\tif (room.rightPopup) {\r\n\r\n\t\t\tif (availableHeight > offset.top + height + 5 &&\r\n\t\t\t\t(offset.top < availableHeight * 2 / 3 || offset.top + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top;\r\n\t\t\t} else if (offset.top + sourceHeight >= height) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top - sourceHeight, 0);\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = Math.max(0, availableHeight - height);\r\n\t\t\t}\r\n\t\t\tlet offsetLeft = offset.left + sourceWidth;\r\n\t\t\tif (width !== 'auto' && offsetLeft + width > document.documentElement.clientWidth) {\r\n\t\t\t\tstyle.right = 1;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offsetLeft;\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\tif (availableHeight > offset.top + sourceHeight + height + 5 &&\r\n\t\t\t\t(offset.top + sourceHeight < availableHeight * 2 / 3 || offset.top + sourceHeight + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top + sourceHeight;\r\n\t\t\t} else if (height + 5 <= offset.top) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top, 0);\r\n\t\t\t} else if (height + 10 < availableHeight) {\r\n\t\t\t\tstyle.bottom = 5;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = 0;\r\n\t\t\t}\r\n\r\n\t\t\tlet availableWidth = document.documentElement.clientWidth - offset.left;\r\n\t\t\tif (width !== 'auto' && availableWidth < width + 10) {\r\n\t\t\t\tstyle.right = 10;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offset.left;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (width) style.maxWidth = width;\r\n\r\n\t\treturn style;\r\n\t}\r\n\trenderRoom(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\treturn <Panel key={room.id} room={room} />;\r\n\t}\r\n\trenderPopup(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\tif (room.location === 'popup' && room.parentElem) {\r\n\t\t\treturn <Panel key={room.id} room={room} />;\r\n\t\t}\r\n\t\treturn <div key={room.id} class=\"ps-overlay\">\r\n\t\t\t<Panel room={room} />\r\n\t\t</div>;\r\n\t}\r\n\trender() {\r\n\t\tlet rooms = [] as preact.VNode[];\r\n\t\tfor (const roomid in PS.rooms) {\r\n\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\tif (room.location === 'left' || room.location === 'right') {\r\n\t\t\t\trooms.push(this.renderRoom(room));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn <div class=\"ps-frame\">\r\n\t\t\t<PSHeader style={{top: 0, left: 0, right: 0, height: '50px'}} />\r\n\t\t\t{rooms}\r\n\t\t\t{PS.popups.map(roomid => this.renderPopup(PS.rooms[roomid]!))}\r\n\t\t</div>;\r\n\t}\r\n}\r\n\r\ntype PanelPosition = {top?: number, bottom?: number, left?: number, right?: number} | null;\r\n\r\nfunction SanitizedHTML(props: {children: string}) {\r\n\treturn <div dangerouslySetInnerHTML={{__html: BattleLog.sanitizeHTML(props.children)}}/>;\r\n}\r\n"],"mappings":"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"}